<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Declaración de Obras Audiovisuales</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="icon" type="image/png" href="assets/solologo.png">
</head>

<body>
  <header class="header">
    <a href="https://atn.cl" target="_blank"><img src="assets/Logo-Fondo-Transparente@3x(1).png" alt="Logo organización"
        class="logo"></a>
    <h1>Declaración de Obras Audiovisuales</h1>
  </header>
  <main>
    <div class="progress-container">
      <div class="progress-container-inner">
        <button class="nav-arrow prev" aria-label="Anterior">
          <i class="fas fa-chevron-left"></i>
        </button>
        <div class="progress-slider">
          <div class="progress-track">
            <div class="progress-slide" data-step="1">
              <div class="progress-step">1</div>
              <span class="step-label">Datos Generales</span>
            </div>
            <div class="progress-slide" data-step="2">
              <div class="progress-step">2</div>
              <span class="step-label">Exhibición Internacional</span>
            </div>
            <div class="progress-slide" data-step="3">
              <div class="progress-step">3</div>
              <span class="step-label">Datos Técnicos</span>
            </div>
            <div class="progress-slide" data-step="4">
              <div class="progress-step">4</div>
              <span class="step-label">Participaciones</span>
            </div>
            <div class="progress-slide" data-step="5">
              <div class="progress-step">5</div>
              <span class="step-label">Episodios</span>
            </div>
            <div class="progress-slide" data-step="6">
              <div class="progress-step">6</div>
              <span class="step-label">Firma</span>
            </div>
          </div>
        </div>
        <button class="nav-arrow next" aria-label="Siguiente">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
    <form id="wizard-form" autocomplete="off">
      <div class="wizard-container">
        <section id="step-1" class="wizard-step"></section>
        <section id="step-2" class="wizard-step"></section>
        <section id="step-3" class="wizard-step"></section>
        <section id="step-4" class="wizard-step">
          <div id="participaciones-bloqueada" class="subbloque" style="display:none;">
            <div class="subbloque-header-collapsible">
              <h4>Participaciones</h4>
            </div>
            <div class="subbloque-content">
              <div class="bloqueado-mensaje"
                style="background:#f8d7da;color:#721c24;padding:20px;border-radius:8px;border:1px solid #f5c6cb;margin-bottom:20px;">
                <i class="fas fa-lock" style="margin-right:8px;"></i>
                La sección de participaciones está bloqueada porque la participación se gestiona por episodio. En la
                siguiente sección puedes gestionar las participaciones por episodio.
              </div>
            </div>
          </div>
          <!-- Aquí va el contenido normal de participaciones, que debe ocultarse si la obra es serializada -->
        </section>
        <section id="step-5" class="wizard-step">
          <!-- Subbloque 2: Títulos de episodios -->
          <div class="subbloque">
            <div class="subbloque-header-collapsible">
              <h4>Títulos de episodios</h4>
              <button type="button" class="btn-toggle-subbloque">
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>
            <div class="subbloque-content">
              <div class="episodios-titulos"></div>
              <button type="button" class="btn btn-outline-success btn-gestionar-titulos" style="margin-top:10px;">
                <i class="fas fa-table"></i> Gestionar Otros Títulos
              </button>
            </div>
          </div>
        </section>
        <section id="step-6" class="wizard-step">
          <div class="subbloque">
            <div class="subbloque-header-collapsible">
              <h4>Firma Digital</h4>
              <button type="button" class="btn-toggle-subbloque">
                <i class="fas fa-chevron-down"></i>
              </button>
            </div>
            <div class="subbloque-content">
              <!-- Instrucciones sobre la generación automática -->
              <div class="firma-instrucciones">
                <div class="info-box">
                  <i class="fas fa-info-circle"></i>
                  <div class="info-content">
                    <h5>Generación Automática de Documento</h5>
                    <p>Una vez completado el formulario y adjuntada tu firma, se generará automáticamente un
                      documento oficial con todos los datos ingresados. Este proceso se realizará mediante
                      automatizaciones y el documento final incluirá tu firma digital.
                    </p>
                  </div>
                </div>
              </div>

              <!-- Vista previa de la plantilla -->
              <div class="plantilla-preview">
                <h5><i class="fas fa-eye"></i> Vista Previa de la Plantilla</h5>
                <div class="preview-container">
                  <div class="preview-notice">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Esta es solo una vista previa de la plantilla. El documento final se generará y enviará a tu
                      correo automáticamente con sus datos.</span>
                  </div>
                  <div class="preview-document">
                    <iframe src="assets/docs/DeclaracionAV.pdf" width="100%" height="600px"
                      style="border: 1px solid #ddd; border-radius: 8px;">
                      <p>Su navegador no soporta la visualización de PDFs.
                        <a href="assets/docs/DeclaracionAV.pdf" target="_blank">Haga clic aquí para descargar el
                          documento</a>
                      </p>
                    </iframe>
                    <small style="display: block; margin-top: 10px; color: #666;">Documento de prueba - El documento
                      final contendrá todos los datos del formulario junto con su firma digital</small>
                  </div>
                </div>
              </div>

              <!-- Sección de identificación y firma -->
              <div class="firma-upload">
                <h5><i class="fas fa-user-check"></i> Identificación del Declarante</h5>

                <!-- Instrucciones -->
                <div class="firma-instructions">
                  <div class="instruction-box">
                    <i class="fas fa-info-circle"></i>
                    <div class="instruction-content">
                      <p><strong>Información requerida:</strong></p>
                      <ul>
                        <li>Completa tus datos personales (Nombre completo y RUT)</li>
                        <li>Adjunta tu firma digital en formato PNG o JPG</li>
                        <li>Esta información será incluida en el documento oficial de declaración</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <!-- Campos de identificación -->
                <div class="identification-fields">
                  <div class="form-row">
                    <div class="form-group">
                      <label for="declarante-nombre">
                        <i class="fas fa-user"></i> Nombre Completo *
                      </label>
                      <input type="text" id="declarante-nombre" name="declarante-nombre" class="form-control"
                        placeholder="Ingresa tu nombre completo" required>
                      <div class="input-hint">Nombre y apellidos como aparecen en tu cédula de identidad</div>
                    </div>

                    <div class="form-group">
                      <label for="declarante-rut">
                        <i class="fas fa-id-card"></i> RUT *
                      </label>
                      <input type="text" id="declarante-rut" name="declarante-rut" class="form-control"
                        placeholder="12.345.678-9" maxlength="12" required>
                      <div class="input-hint">Formato: 12.345.678-9 (con puntos y guión)</div>
                      <div class="input-error" id="rut-error" style="display: none;">RUT inválido. Verifique el formato
                        y dígito verificador.</div>
                    </div>
                  </div>

                  <!-- Nueva fila para el correo electrónico -->
                  <div class="form-row">
                    <div class="form-group">
                      <label for="declarante-correo">
                        <i class="fas fa-envelope"></i> Correo Electrónico *
                      </label>
                      <input type="email" id="declarante-correo" name="declarante-correo" class="form-control"
                        placeholder="ejemplo@correo.com" required>
                      <div class="input-hint">Se enviará confirmación a este correo</div>
                      <div class="input-error" id="correo-error" style="display: none;">Correo electrónico inválido.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Campo de subida de firma -->
                <div class="signature-section">
                  <h6><i class="fas fa-signature"></i> Firma Digital *</h6>
                  
                  <!-- Nota informativa sobre la firma -->
                  <div class="firma-info-grid">
                    <div class="firma-info-item">
                      <div class="firma-info-header">
                        <i class="fas fa-info-circle"></i>
                        <strong>Importante</strong>
                      </div>
                      <p>Tu firma solo será utilizada para incluirla en la ficha de declaración de obra audiovisual y <strong>no se almacenará ni usará para ningún otro fin</strong>. Esto permitirá simplificar y finalizar el proceso de declaración ya que no se requerirá ninguna otra acción por parte tuya.</p>
                    </div>
                    
                    <div class="firma-info-item">
                      <div class="firma-info-header">
                        <i class="fas fa-question-circle"></i>
                        <strong>¿Qué ocurre si no sube su firma?</strong>
                      </div>
                      <p>Si decides <strong>no subir tu firma</strong>, igualmente se generará automáticamente la ficha de declaración de obra audiovisual con todos los datos ingresados en el formulario <strong>excepto la firma</strong>. Lo recibirás por correo electrónico una vez finalizada la declaración pero para hacerla efectiva <strong>deberás firmarlo manualmente</strong> y responder al correo adjuntando el documento firmado.</p>
                    </div>
                  </div>
                  
                  <div class="upload-container">
                    <div class="file-input-wrapper">
                      <input type="file" id="firma-file" name="firma" accept=".png,.jpg,.jpeg" class="file-input">
                      <label for="firma-file" class="file-input-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span class="file-text">Seleccionar archivo de firma</span>
                        <span class="file-formats">Formatos permitidos: PNG, JPG</span>
                      </label>
                    </div>
                    <div class="file-preview" id="firma-preview" style="display:none;">
                      <div class="preview-image-container">
                        <img id="firma-image" src="" alt="Vista previa de la firma">
                        <button type="button" class="btn-remove-file" onclick="removeSignatureFile()">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                      <div class="file-info">
                        <span class="file-name" id="firma-filename"></span>
                        <span class="file-size" id="firma-filesize"></span>
                      </div>
                    </div>
                  </div>

                  <!-- Checkbox de declaración de veracidad -->
                  <div class="declaration-checkbox-section">
                    <div class="form-group">
                      <div class="checkbox-container">
                        <input type="checkbox" id="declaracion-veracidad" name="declaracion-veracidad" required>
                        <label for="declaracion-veracidad">
                          El(los) firmante(s) declara(n) que los datos consignados en este formulario son ciertos y
                          correctos y se responsabiliza(n) ante terceros de la exactitud de lo aquí declarado.
                        </label>
                      </div>
                      <div class="input-error" id="declaracion-error" style="display: none;">Debe aceptar la declaración
                        de veracidad.</div>
                    </div>

                    <!-- Sección de notificación a participantes -->
                    <div class="form-group mt-4">
                      <div id="seccion-notificacion-participantes" class="seccion-notificacion">
                        <!-- Esta sección se llenará dinámicamente con JavaScript -->
                        <div class="notificacion-header">
                          <h4>Notificación a participantes</h4>
                          <p>Al enviar este formulario, se notificará automáticamente a los siguientes participantes:
                          </p>
                          <div class="alerta-correos">Puede haber autores sin correo electrónico actualizado. Se
                            recomienda notificarlos manualmente mientras se actualizan los datos en ATN.</div>
                        </div>
                        <ul class="lista-participantes-notificacion">
                          <li>No hay participantes para notificar</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </section>
      </div>
      <div class="wizard-buttons">
        <button type="button" id="cancel-btn" class="btn btn-secondary">Cancelar</button>
        <button type="button" id="prev-btn" class="btn" disabled>Atrás</button>
        <button type="button" id="next-btn" class="btn btn-primary">Siguiente</button>
        <button type="submit" id="submit-btn" class="btn btn-success" style="display:none">Enviar Declaración</button>
      </div>
    </form>
    <div id="form-message" class="form-message"></div>

    <!-- Modal para gestionar participaciones (único) -->
    <div id="modalParticipaciones" class="modal-atn" style="display:none;">
      <div class="modal-atn-content" style="max-width:900px;">
        <div class="modal-atn-header-green">
          <h3>Gestionar participaciones</h3>
        </div>
        <div class="modal-atn-body">
          <div class="tabla-participaciones-container">
            <table class="tabla-participaciones">
              <thead>
                <tr>
                  <th>Rol</th>
                  <th>Autor</th>
                  <th>Porcentaje</th>
                  <th>Eliminar</th>
                </tr>
              </thead>
              <tbody>
                <!-- Filas dinámicas -->
              </tbody>
            </table>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
            <button type="button" class="btn btn-outline-success btn-agregar-participacion">
              <i class="fas fa-plus"></i> Agregar participación
            </button>
          </div>
          <div id="participacion-resumen-modal" class="participacion-resumen"></div>
          <div id="participaciones-modal-error" class="form-message" style="color:#dc3545;margin-top:10px;"></div>
          <div class="modal-atn-buttons"
            style="display: flex; justify-content: flex-end; gap: 16px; padding: 0 36px; margin-top: 24px;">
            <button type="button" class="btn btn-success btn-guardar-participaciones">Guardar cambios</button>
            <button type="button" class="btn btn-secondary btn-cerrar-participaciones">Cerrar</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Fin modalParticipaciones único -->
  </main>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="form-wizard.js"></script>
  <!-- Modal de confirmación para cancelar -->
  <div id="modalCancelar" class="modal-atn">
    <div class="modal-atn-content">
      <div class="modal-atn-header-green">
        <h3>Confirmar Cancelación</h3>
      </div>
      <div class="modal-atn-message">
        <p>¿Está seguro que desea cancelar la declaración? Todos los datos ingresados se perderán.</p>
      </div>
      <div class="modal-atn-buttons">
        <button type="button" id="modalCancelarSi" class="modal-btn-lg btn-secondary">Sí, Cancelar</button>
        <button type="button" id="modalCancelarNo" class="modal-btn-lg btn-primary">No, Continuar</button>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
      <div class="spinner-institucional">
        <svg width="50" height="50" viewBox="0 0 50 50">
          <circle cx="25" cy="25" r="20" fill="none" stroke="#097137" stroke-width="4" stroke-linecap="round"
            stroke-dasharray="31.416" stroke-dashoffset="31.416">
            <animate attributeName="stroke-dashoffset" dur="1.5s" values="31.416;0;31.416" repeatCount="indefinite" />
          </circle>
        </svg>
      </div>
      <p>Cancelando y limpiando datos...</p>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>

</html>

<!-- Modal para gestionar otros títulos por episodio -->
<div id="modalTitulosEpisodio" class="modal-atn" style="display:none;">
  <div class="modal-atn-content" style="max-width:900px;">
    <div class="modal-atn-header-green">
      <h3>Otros títulos por episodio</h3>
    </div>
    <div class="modal-atn-body">
      <table class="tabla-titulos-episodio">
        <thead>
          <tr>
            <th>Episodio</th>
            <th>Otro título</th>
            <th>Idioma</th>
            <th>País</th>
            <th>Eliminar</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filas dinámicas -->
        </tbody>
      </table>
      <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
        <button type="button" class="btn btn-outline-success btn-agregar-titulo-episodio">
          <i class="fas fa-plus"></i> Agregar otro título
        </button>
        <button type="button" class="btn btn-secondary btn-ayuda-importar">
          <i class="fas fa-question-circle"></i> Ayuda importación
        </button>
        <button type="button" class="btn btn-secondary btn-importar-titulos-episodio">
          <i class="fas fa-file-import"></i> Importar títulos
        </button>
        <input type="file" accept=".csv, .xlsx, .xls" class="input-importar-titulos-episodio" style="display:none">
        <button type="button" class="btn btn-secondary btn-pegar-titulos-episodio">
          <i class="fas fa-paste"></i> Pegar títulos
        </button>
      </div>
    </div>
    <div class="modal-atn-buttons" style="margin-top:20px;">
      <button type="button" class="btn btn-success btn-guardar-titulos-episodio">Guardar cambios</button>
      <button type="button" class="btn btn-secondary btn-cerrar-titulos-episodio">Cerrar</button>
    </div>
  </div>
</div>



<!-- Modal de ayuda para importación -->
<div id="modalAyudaImportar" class="modal-atn" style="display:none;">
  <div class="modal-atn-content">
    <div class="modal-atn-header-green">
      <h3>Ayuda para importación de títulos</h3>
    </div>
    <div class="modal-atn-body">
      <h4>Importar desde archivo Excel/CSV</h4>
      <p>El archivo debe contener las siguientes columnas en orden:</p>
      <ol>
        <li><strong>Episodio:</strong> Número del episodio</li>
        <li><strong>Título:</strong> Título alternativo del episodio</li>
        <li><strong>Idioma:</strong> Idioma del título</li>
        <li><strong>País:</strong> País donde se utiliza el título</li>
      </ol>
      <p><small>Nota: No es necesario incluir encabezados en el archivo.</small></p>

      <h4>Pegar títulos</h4>
      <p>Al usar la opción "Pegar títulos", debe seguir el formato:</p>
      <pre>Episodio,Título,Idioma,País</pre>
      <p>Ejemplo:</p>
      <pre>1,Título alternativo,Español,Chile
2,Alternative title,Inglés,Estados Unidos</pre>
    </div>
    <div class="modal-atn-buttons">
      <button type="button" class="btn btn-success btn-cerrar-ayuda">Entendido</button>
    </div>
  </div>
</div>

<!-- Modal para pegar títulos de episodios -->
<div id="modalPegarTitulosEpisodio" class="modal-atn" style="display:none;">
  <div class="modal-atn-content">
    <div class="modal-atn-header-green">
      <h3>Pegar títulos de episodios</h3>
    </div>
    <div class="modal-atn-body">
      <p>Pegue los títulos de los episodios en el siguiente formato:</p>
      <p><small>Episodio | Otro título | Idioma | País</small></p>
      <textarea id="textareaPegarTitulos" placeholder="1 | Título alternativo | Español | Chile
2 | Alternative title | Inglés | Estados Unidos"></textarea>
    </div>
    <div class="modal-atn-buttons">
      <button type="button" class="btn-aceptar-pegar">Aceptar</button>
      <button type="button" class="btn-cancelar-pegar">Cancelar</button>
    </div>
  </div>
</div>
